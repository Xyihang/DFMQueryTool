import toga
from toga.style import Pack
from toga.style.pack import COLUMN, ROW
import requests
import json
from datetime import datetime, timedelta
import os
import configparser
import pyperclip


class DFMQueryApp(toga.App):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.config_file = None
        self.openid = ""
        self.access_token = ""

    def load_config(self):
        """åŠ è½½ç”¨æˆ·é…ç½®"""
        if self.config_file is None:
            self.openid = ""
            self.access_token = ""
            return

        config = configparser.ConfigParser()
        if os.path.exists(self.config_file):
            config.read(self.config_file)
            if config.has_section('User'):
                self.openid = config.get('User', 'openid', fallback='')
                self.access_token = config.get('User', 'access_token', fallback='')

    def save_config(self):
        """ä¿å­˜ç”¨æˆ·é…ç½®"""
        config = configparser.ConfigParser()
        config['User'] = {
            'openid': self.openid,
            'access_token': self.access_token
        }
        with open(self.config_file, 'w', encoding='utf-8') as configfile:
            config.write(configfile)

    def startup(self):
        self.config_file = self.paths.config / "user_config.ini"
        self.load_config()

        # ä¸»çª—å£
        self.main_window = toga.MainWindow(title="DFMæŸ¥è¯¢å·¥å…· --Made by Xyihang", size=(700, 650))

        # åˆ›å»ºUIç»„ä»¶
        main_box = toga.Box(style=Pack(direction=COLUMN, margin=8))

        # æ ‡é¢˜
        title_label = toga.Label(
            "DFMæ¸¸æˆæ•°æ®æŸ¥è¯¢å·¥å…· --Made by Xyihang",
            style=Pack(font_size=18, font_weight="bold", margin_bottom=15)
        )

        # ç”¨æˆ·é…ç½®åŒºåŸŸ - ç´§å‡‘å¸ƒå±€ï¼Œæ”¯æŒæŠ˜å 
        self.config_box = toga.Box(style=Pack(direction=COLUMN, margin=5, background_color="#f5f5f5"))

        # æ ‡é¢˜ã€æŠ˜å æŒ‰é’®å’Œä¿å­˜æŒ‰é’®åœ¨åŒä¸€è¡Œ
        header_box = toga.Box(style=Pack(direction=ROW, margin_bottom=5))
        config_label = toga.Label(
            "ç”¨æˆ·é…ç½®",
            style=Pack(font_size=14, font_weight="bold")
        )
        self.toggle_button = toga.Button(
            "â–²",
            on_press=self.toggle_config,
            style=Pack(margin_left=10, padding=(5, 2), background_color="#607D8B", color="white", width=30)
        )
        save_button = toga.Button(
            "ä¿å­˜",
            on_press=self.save_user_config,
            style=Pack(margin_left=5, padding=(5, 2), background_color="#2196F3", color="white")
        )
        header_box.add(config_label)
        header_box.add(self.toggle_button)
        header_box.add(save_button)

        # è¾“å…¥æ¡†å®¹å™¨ - ä½¿ç”¨æ›´ç´§å‡‘çš„å¸ƒå±€
        inputs_container = toga.Box(style=Pack(direction=COLUMN))

        # OpenIDè¾“å…¥æ¡†
        openid_box = toga.Box(style=Pack(direction=ROW, margin=2))
        openid_label = toga.Label("OpenID:", style=Pack(width=70, margin_right=8, font_size=12))
        self.openid_input = toga.TextInput(
            placeholder="è¯·è¾“å…¥OpenID",
            value=self.openid,
            style=Pack(flex=1, height=30)
        )
        openid_box.add(openid_label)
        openid_box.add(self.openid_input)

        # Access Tokenè¾“å…¥æ¡†
        token_box = toga.Box(style=Pack(direction=ROW, margin=2))
        token_label = toga.Label("Access Token:", style=Pack(width=70, margin_right=8, font_size=12))
        self.token_input = toga.TextInput(
            placeholder="è¯·è¾“å…¥Access Token",
            value=self.access_token,
            style=Pack(flex=1, height=30)
        )
        token_box.add(token_label)
        token_box.add(self.token_input)

        inputs_container.add(openid_box)
        inputs_container.add(token_box)

        # ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º - æ›´ç´§å‡‘
        status_box = toga.Box(style=Pack(direction=ROW, margin_top=5))
        self.user_info_label = toga.Label(
            f"ç”¨æˆ·: {self.openid[:10] + '...' if self.openid and len(self.openid) > 10 else (self.openid if self.openid else 'æœªè®¾ç½®')}",
            style=Pack(font_size=10, color="gray")
        )
        status_box.add(self.user_info_label)

        # å¯æŠ˜å çš„å†…å®¹å®¹å™¨
        self.config_content = toga.Box(style=Pack(direction=COLUMN))
        self.config_content.add(inputs_container)
        self.config_content.add(status_box)

        self.config_box.add(header_box)
        self.config_box.add(self.config_content)

        # åˆå§‹åŒ–é…ç½®åŒºåŸŸå¯è§çŠ¶æ€
        self.config_visible = True

        # æŸ¥è¯¢ç±»å‹é€‰æ‹©
        query_type_box = toga.Box(style=Pack(direction=ROW, margin=5))
        query_type_label = toga.Label("æŸ¥è¯¢ç±»å‹:", style=Pack(font_size=14, margin_right=10))

        # åˆ›å»ºé€‰æ‹©æ¡†
        self.query_type = toga.Selection(
            items=["æ¯æ—¥å¯†ç ", "çƒ½ç«åœ°å¸¦æ”¶ç›ŠTop3", "å…¨é¢æˆ˜åœºæ•°æ®", "æˆ˜åœºå‘¨æŠ¥æ•°æ®", "çƒ½ç«å‘¨æŠ¥æ•°æ®", "ç‰¹å‹¤å¤„çŠ¶æ€", "è´§å¸èµ„äº§æŸ¥è¯¢"],
            style=Pack(flex=1)
        )

        query_type_box.add(query_type_label)
        query_type_box.add(self.query_type)

        # æŸ¥è¯¢æŒ‰é’®å®¹å™¨
        button_container = toga.Box(style=Pack(direction=ROW, margin=5))

        # æŸ¥è¯¢æŒ‰é’®
        query_button = toga.Button(
            "æŸ¥è¯¢æ•°æ®",
            on_press=self.query_data,
            style=Pack(flex=1, margin_right=5, background_color="#4CAF50", color="white")
        )

        # å¸®åŠ©æŒ‰é’®
        help_button = toga.Button(
            "è·å–å¸®åŠ©",
            on_press=self.get_help,
            style=Pack(flex=1, background_color="#FF9800", color="white")
        )

        button_container.add(query_button)
        button_container.add(help_button)

        # ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        result_label = toga.Label("æŸ¥è¯¢ç»“æœ:", style=Pack(font_size=14, font_weight="bold", margin_top=10))

        self.result_text = toga.MultilineTextInput(
            style=Pack(flex=1, margin=5, padding=10),
            readonly=True,
            placeholder="é€‰æ‹©æŸ¥è¯¢ç±»å‹å¹¶ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®è·å–æ•°æ®..."
        )

        # çŠ¶æ€æ 
        self.status_label = toga.Label("å°±ç»ª", style=Pack(font_size=10, color="gray", margin_top=5))

        # ç»„è£…UI
        main_box.add(title_label)
        main_box.add(self.config_box)
        main_box.add(query_type_box)
        main_box.add(button_container)
        main_box.add(result_label)
        main_box.add(self.result_text)
        main_box.add(self.status_label)

        self.main_window.content = main_box
        self.main_window.show()

    def toggle_config(self, widget):
        """åˆ‡æ¢ç”¨æˆ·é…ç½®åŒºåŸŸçš„æ˜¾ç¤º/éšè—"""
        try:
            # æ£€æŸ¥å½“å‰çŠ¶æ€
            if hasattr(self, 'config_visible') and self.config_visible:
                # éšè—é…ç½®å†…å®¹
                self.config_box.remove(self.config_content)
                self.toggle_button.text = "â–¼"
                self.config_visible = False
            else:
                # æ˜¾ç¤ºé…ç½®å†…å®¹
                self.config_box.add(self.config_content)
                self.toggle_button.text = "â–²"
                self.config_visible = True
        except Exception as e:
            print(f"åˆ‡æ¢é…ç½®åŒºåŸŸæ—¶å‡ºé”™: {e}")

    def get_help(self, widget):
        """è·å–å¸®åŠ©æ–‡æ¡£å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿"""
        try:
            self.status_label.text = "æ­£åœ¨è·å–å¸®åŠ©æ–‡æ¡£..."

            # è·å–å¸®åŠ©æ–‡æ¡£å†…å®¹
            help_url = "https://docs.qq.com/document/DS2hWc29pSGVIa3dM"
            response = requests.get(help_url, timeout=15)

            if response.status_code == 200:
                # å°è¯•è·å–æ–‡æ¡£å†…å®¹
                try:
                    # ç›´æ¥è·å–æ–‡æ¡£é¡µé¢å†…å®¹
                    import re
                    page_content = response.text

                    # å°è¯•æå–æ–‡æ¡£æ ‡é¢˜å’Œä¸»è¦å†…å®¹
                    title_match = re.search(r'<title[^>]*>([^<]+)</title>', page_content, re.IGNORECASE)
                    title = title_match.group(1).strip() if title_match else "DFMæŸ¥è¯¢å·¥å…·å¸®åŠ©æ–‡æ¡£"

                    # åŸºç¡€å¸®åŠ©ä¿¡æ¯
                    help_content = f"{title}\n\n"
                    help_content += f"æ–‡æ¡£é“¾æ¥: {help_url}\n\n"
                    help_content += "=== DFMæŸ¥è¯¢å·¥å…·ä½¿ç”¨è¯´æ˜ ===\n\n"
                    help_content += "1. ç”¨æˆ·é…ç½®ï¼š\n"
                    help_content += "   - è¾“å…¥æ‚¨çš„OpenIDå’ŒAccess Token\n"
                    help_content += "   - ç‚¹å‡»ä¿å­˜æŒ‰é’®ä¿å­˜é…ç½®\n\n"
                    help_content += "2. æŸ¥è¯¢åŠŸèƒ½ï¼š\n"
                    help_content += "   - é€‰æ‹©æŸ¥è¯¢ç±»å‹\n"
                    help_content += "   - ç‚¹å‡»æŸ¥è¯¢æ•°æ®è·å–ç»“æœ\n\n"
                    help_content += "3. æ”¯æŒçš„æŸ¥è¯¢ç±»å‹ï¼š\n"
                    help_content += "   - æ¯æ—¥å¯†ç ï¼šè·å–å½“æ—¥åœ°å›¾å¯†ç \n"
                    help_content += "   - çƒ½ç«åœ°å¸¦æ”¶ç›ŠTop3ï¼šæŸ¥çœ‹æ˜¨æ—¥é«˜ä»·å€¼ç‰©å“\n"
                    help_content += "   - å…¨é¢æˆ˜åœºæ•°æ®ï¼šæŸ¥çœ‹MPæ¨¡å¼æˆ˜ç»©\n"
                    help_content += "   - æˆ˜åœºå‘¨æŠ¥æ•°æ®ï¼šæŸ¥çœ‹æœ¬å‘¨MPç»Ÿè®¡\n"
                    help_content += "   - çƒ½ç«å‘¨æŠ¥æ•°æ®ï¼šæŸ¥çœ‹æœ¬å‘¨Solç»Ÿè®¡\n"
                    help_content += "   - ç‰¹å‹¤å¤„çŠ¶æ€ï¼šæŸ¥çœ‹ç‰¹å‹¤å¤„è®¾æ–½çŠ¶æ€\n"
                    help_content += "   - è´§å¸èµ„äº§æŸ¥è¯¢ï¼šæŸ¥çœ‹æ¸¸æˆè´§å¸ä½™é¢\n\n"
                    help_content += "4. åŠŸèƒ½ç‰¹æ€§ï¼š\n"
                    help_content += "   - å¯æŠ˜å çš„ç”¨æˆ·é…ç½®åŒºåŸŸ\n"
                    help_content += "   - è‡ªåŠ¨ç‰©å“åç§°è¯†åˆ«\n"
                    help_content += "   - è¯¦ç»†çš„æ•°æ®æ ¼å¼åŒ–æ˜¾ç¤º\n"
                    help_content += "   - é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æç¤º\n\n"
                    help_content += "5. å¸¸è§é—®é¢˜ï¼š\n"
                    help_content += "   - å¦‚æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥\n"
                    help_content += "   - å¦‚æ˜¾ç¤ºé…ç½®é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥å‡­è¯\n"
                    help_content += "   - å¯æŠ˜å é…ç½®åŒºåŸŸä»¥è·å¾—æ›´å¤§æŸ¥çœ‹ç©ºé—´\n\n"
                    help_content += f"å®Œæ•´æ–‡æ¡£è¯·è®¿é—®ï¼š{help_url}"

                except Exception as extract_error:
                    help_content = "DFMæŸ¥è¯¢å·¥å…·å¸®åŠ©æ–‡æ¡£\n\nè·å–è¯¦ç»†æ–‡æ¡£ï¼š\n" + help_url + "\n\næ­¤å·¥å…·ç”¨äºæŸ¥è¯¢çƒ½ç«åœ°å¸¦æ¸¸æˆæ•°æ®ï¼Œæ”¯æŒå¤šç§æŸ¥è¯¢ç±»å‹ã€‚å¦‚éœ€è¯¦ç»†ä½¿ç”¨è¯´æ˜ï¼Œè¯·è®¿é—®ä¸Šè¿°é“¾æ¥ã€‚"

                # å¤åˆ¶åˆ°å‰ªè´´æ¿
                try:
                    pyperclip.copy(help_content)
                    self.status_label.text = "å¸®åŠ©æ–‡æ¡£å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"

                    # æ˜¾ç¤ºç®€çŸ­çš„æç¤ºä¿¡æ¯
                    self.result_text.value = "=== å¸®åŠ©æ–‡æ¡£è·å–æˆåŠŸ ===\n\nâœ… å¸®åŠ©æ–‡æ¡£å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿\nğŸ“– æ‚¨å¯ä»¥ç›´æ¥ç²˜è´´åˆ°æ–‡æœ¬ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹\n\nğŸŒ æ–‡æ¡£é“¾æ¥ï¼š\n" + help_url + "\n\nğŸ’¡ æç¤ºï¼š\nâ€¢ å¦‚æœå‰ªè´´æ¿å†…å®¹ä¸ºç©ºï¼Œè¯·æ‰‹åŠ¨è®¿é—®ä¸Šæ–¹é“¾æ¥\nâ€¢ æ–‡æ¡£åŒ…å«è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œå¸¸è§é—®é¢˜è§£ç­”"

                except Exception as clipboard_error:
                    # å¦‚æœå‰ªè´´æ¿æ“ä½œå¤±è´¥ï¼Œæä¾›æ›¿ä»£æ–¹æ¡ˆ
                    self.status_label.text = "å‰ªè´´æ¿æ“ä½œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¿é—®"
                    self.result_text.value = "=== å¸®åŠ©æ–‡æ¡£ ===\n\nâš ï¸ è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥\n\nğŸŒ è¯·æ‰‹åŠ¨è®¿é—®æ–‡æ¡£é“¾æ¥ï¼š\n" + help_url + "\n\nğŸ“‹ æ‚¨ä¹Ÿå¯ä»¥å¤åˆ¶ä¸‹é¢çš„é“¾æ¥ï¼š\n" + help_url + "\n\nğŸ’¡ å»ºè®®å°†æ–‡æ¡£é“¾æ¥ä¿å­˜åˆ°ä¹¦ç­¾ä»¥ä¾¿å¿«é€Ÿè®¿é—®"

            else:
                self.status_label.text = "æ— æ³•è®¿é—®å¸®åŠ©æ–‡æ¡£"
                self.result_text.value = f"=== è·å–å¸®åŠ©æ–‡æ¡£å¤±è´¥ ===\n\nâŒ HTTPé”™è¯¯: {response.status_code}\n\nğŸŒ è¯·æ‰‹åŠ¨è®¿é—®ï¼š\n" + help_url + "\n\nğŸ’¡ å¯èƒ½åŸå› ï¼š\nâ€¢ ç½‘ç»œè¿æ¥é—®é¢˜\nâ€¢ æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨\nâ€¢ æ–‡æ¡£é“¾æ¥å·²æ›´æ”¹"

        except Exception as e:
            self.status_label.text = "è·å–å¸®åŠ©å¤±è´¥"
            self.result_text.value = f"=== è·å–å¸®åŠ©æ–‡æ¡£æ—¶å‘ç”Ÿé”™è¯¯ ===\n\nğŸ”§ é”™è¯¯ä¿¡æ¯: {str(e)}\n\nğŸŒ è¯·æ‰‹åŠ¨è®¿é—®æ–‡æ¡£é“¾æ¥ï¼š\nhttps://docs.qq.com/document/DS2hWc29pSGVIa3dM\n\nğŸ’¡ å»ºè®®ï¼š\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\nâ€¢ ç¨åé‡è¯•\nâ€¢ æˆ–è€…æ‰‹åŠ¨è®¿é—®æ–‡æ¡£é“¾æ¥"

    def save_user_config(self, widget):
        """ä¿å­˜ç”¨æˆ·é…ç½®"""
        try:
            self.openid = self.openid_input.value.strip()
            self.access_token = self.token_input.value.strip()

            # éªŒè¯å¿…å¡«å­—æ®µ
            if not self.openid:
                self.result_text.value = "é”™è¯¯: OpenIDä¸èƒ½ä¸ºç©º"
                return

            # ä¿å­˜é…ç½®
            self.save_config()

            # æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            self.user_info_label.text = f"ç”¨æˆ·: {self.openid[:10] + '...' if self.openid and len(self.openid) > 10 else (self.openid if self.openid else 'æœªè®¾ç½®')}"

            # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            self.result_text.value = "é…ç½®ä¿å­˜æˆåŠŸï¼\n\nç°åœ¨å¯ä»¥ä½¿ç”¨æŸ¥è¯¢åŠŸèƒ½äº†ã€‚"
            self.status_label.text = "é…ç½®å·²ä¿å­˜"

        except Exception as e:
            self.result_text.value = f"ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"
            self.status_label.text = "ä¿å­˜å¤±è´¥"

    def query_data(self, widget):
        """æŸ¥è¯¢æ•°æ®"""
        try:
            self.status_label.text = "æ­£åœ¨æŸ¥è¯¢ä¸­..."

            # æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
            if not self.openid:
                self.result_text.value = "é”™è¯¯: è¯·å…ˆåœ¨ç”¨æˆ·é…ç½®åŒºåŸŸè®¾ç½®OpenIDå¹¶ä¿å­˜é…ç½®"
                self.status_label.text = "é…ç½®ä¸å®Œæ•´"
                return

            # æ ¹æ®é€‰æ‹©ç±»å‹ç¡®å®šå‚æ•°
            query_type = self.query_type.value
            if query_type == "æ¯æ—¥å¯†ç ":
                param_value = '{}'
                query_func = self.query_daily_secret
            elif query_type == "çƒ½ç«åœ°å¸¦æ”¶ç›ŠTop3":
                param_value = '{"resourceType":"sol"}'
                query_func = self.query_sol_data
            elif query_type == "å…¨é¢æˆ˜åœºæ•°æ®":
                param_value = '{"resourceType":"mp"}'
                query_func = self.query_mp_data
            elif query_type == "æˆ˜åœºå‘¨æŠ¥æ•°æ®":
                # è·å–å½“å‰æ—¥æœŸï¼Œè®¡ç®—æœ€è¿‘ä¸€ä¸ªå‘¨æ—¥çš„æ—¥æœŸ
                today = datetime.now()
                # æ‰¾åˆ°æœ€è¿‘çš„å‘¨æ—¥ï¼ˆ0è¡¨ç¤ºå‘¨æ—¥ï¼Œ6è¡¨ç¤ºå‘¨å…­ï¼‰
                days_since_sunday = today.weekday() + 1  # 0=å‘¨ä¸€, 6=å‘¨æ—¥
                last_sunday = today - timedelta(days=days_since_sunday % 7)
                stat_date = last_sunday.strftime('%Y%m%d')

                param_value = f'{{"statDate":"{stat_date}"}}'
                query_func = self.query_weekly_data
            elif query_type == "çƒ½ç«å‘¨æŠ¥æ•°æ®":
                # è·å–å½“å‰æ—¥æœŸï¼Œè®¡ç®—æœ€è¿‘ä¸€ä¸ªå‘¨æ—¥çš„æ—¥æœŸ
                today = datetime.now()
                # æ‰¾åˆ°æœ€è¿‘çš„å‘¨æ—¥ï¼ˆ0è¡¨ç¤ºå‘¨æ—¥ï¼Œ6è¡¨ç¤ºå‘¨å…­ï¼‰
                days_since_sunday = today.weekday() + 1  # 0=å‘¨ä¸€, 6=å‘¨æ—¥
                last_sunday = today - timedelta(days=days_since_sunday % 7)
                stat_date = last_sunday.strftime('%Y%m%d')

                param_value = f'{{"statDate":"{stat_date}"}}'
                query_func = self.query_sol_weekly_data
            elif query_type == "è´§å¸èµ„äº§æŸ¥è¯¢":
                param_value = '{}'
                query_func = self.query_all_currencies
            else:  # ç‰¹å‹¤å¤„çŠ¶æ€
                param_value = '{}'
                query_func = self.query_special_force_status

            # æ ¹æ®æŸ¥è¯¢ç±»å‹è®¾ç½®ä¸åŒçš„APIå‚æ•°
            if query_type == "æ¯æ—¥å¯†ç ":
                # æ¯æ—¥å¯†ç APIé…ç½® - ä½¿ç”¨æ­£ç¡®çš„é…ç½®ï¼Œå‚è€ƒa.py
                url = "https://comm.ams.game.qq.com/ide/"
                params = {
                    'iChartId': '316969',
                    'iSubChartId': '316969',
                    'sIdeToken': 'NoOapI',
                    'method': 'dfm/center.day.secret',
                    'source': '2',
                    'param': param_value
                }
            elif query_type == "æˆ˜åœºå‘¨æŠ¥æ•°æ®":
                # æˆ˜åœºå‘¨æŠ¥APIé…ç½®
                url = "https://comm.ams.game.qq.com/ide/"
                params = {
                    'iChartId': '316968',
                    'iSubChartId': '316968',
                    'sIdeToken': 'KfXJwH',
                    'source': '5',
                    'sArea': '36',
                    'method': 'dfm/weekly.mp.record',
                    'param': param_value
                }
            elif query_type == "çƒ½ç«å‘¨æŠ¥æ•°æ®":
                # çƒ½ç«å‘¨æŠ¥APIé…ç½®
                url = "https://comm.ams.game.qq.com/ide/"
                params = {
                    'iChartId': '316968',
                    'iSubChartId': '316968',
                    'sIdeToken': 'KfXJwH',
                    'source': '5',
                    'sArea': '36',
                    'method': 'dfm/weekly.sol.record',
                    'param': param_value
                }
            elif query_type == "è´§å¸èµ„äº§æŸ¥è¯¢":
                # è´§å¸èµ„äº§æŸ¥è¯¢APIé…ç½® - åŒæ—¶æŸ¥è¯¢ä¸‰ç§è´§å¸ç±»å‹
                url = "https://comm.ams.game.qq.com/ide/"
                params = {
                    'iChartId': '319386',
                    'iSubChartId': '319386',
                    'sIdeToken': 'zMemOt',
                    'type': '3',
                    'param': param_value
                }
                # ä¸‰ç§è´§å¸ç±»å‹çš„ID
                self.currency_items = ['17020000010', '17888808889', '17888808888']  # å“ˆå¤«å¸, ä¸‰è§’åˆ¸, ä¸‰è§’å¸
            elif query_type == "ç‰¹å‹¤å¤„çŠ¶æ€":
                # ç‰¹å‹¤å¤„çŠ¶æ€APIé…ç½®
                url = "https://comm.ams.game.qq.com/ide/"
                params = {
                    'iChartId': '365589',
                    'iSubChartId': '365589',
                    'sIdeToken': 'bQaMCQ',
                    'source': '2',
                    'param': param_value
                }
            else:
                # æ—¥å¸¸æ•°æ®APIé…ç½®
                url = "https://comm.ams.game.qq.com/ide/"
                params = {
                    'iChartId': '316969',
                    'iSubChartId': '316969',
                    'sIdeToken': 'NoOapI',
                    'method': 'dfm/center.recent.detail',
                    'source': '2',
                    'param': param_value
                }

            # è¯·æ±‚å¤´ - ä½¿ç”¨ä¿å­˜çš„é…ç½®
            headers = {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': f'openid={self.openid}; acctype=qc; appid=101491592; access_token={self.access_token}'
            }

            # å‘é€POSTè¯·æ±‚
            response = requests.post(url, params=params, headers=headers, timeout=10)

            # æ‰“å°è°ƒè¯•ä¿¡æ¯
            print(f"æŸ¥è¯¢ç±»å‹: {query_type}")
            print(f"HTTPçŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”å†…å®¹å‰200å­—ç¬¦: {response.text[:200]}")

            if response.status_code == 200:
                # å°è¯•è§£æJSON
                try:
                    data = response.json()
                except json.JSONDecodeError as e:
                    # å¦‚æœJSONè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹å“åº”
                    self.result_text.value = f"JSONè§£æé”™è¯¯: {str(e)}\n\nåŸå§‹å“åº”:\n{response.text}"
                    self.status_label.text = "è§£æé”™è¯¯"
                    return

                # æ£€æŸ¥è¿”å›çŠ¶æ€
                if data.get('ret') == 0 and data.get('iRet') == 0:
                    jdata = data.get('jData', {})

                    # ç‰¹æ®Šå¤„ç†è´§å¸èµ„äº§æŸ¥è¯¢çš„å“åº”ç»“æ„
                    if query_type == "è´§å¸èµ„äº§æŸ¥è¯¢":
                        # åŒæ—¶æŸ¥è¯¢ä¸‰ç§è´§å¸ç±»å‹
                        result = self.query_all_currencies(url, params, headers)
                        self.result_text.value = result
                        if "æŸ¥è¯¢å¤±è´¥" in result:
                            self.status_label.text = "æŸ¥è¯¢å¤±è´¥"
                        else:
                            self.status_label.text = f"æŸ¥è¯¢æˆåŠŸ - {datetime.now().strftime('%H:%M:%S')}"
                    else:
                        # å…¶ä»–æŸ¥è¯¢çš„æ­£å¸¸å¤„ç†é€»è¾‘
                        data_content = jdata.get('data', {})

                        if data_content.get('code') == 0:
                            # è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
                            result = query_func(data_content.get('data', {}))
                            self.result_text.value = result
                            self.status_label.text = f"æŸ¥è¯¢æˆåŠŸ - {datetime.now().strftime('%H:%M:%S')}"
                        else:
                            self.result_text.value = f"APIè¿”å›é”™è¯¯: {data_content.get('msg', 'æœªçŸ¥é”™è¯¯')}"
                            self.status_label.text = "æŸ¥è¯¢å¤±è´¥"
                else:
                    self.result_text.value = f"è¯·æ±‚å¤±è´¥: {data.get('sMsg', 'æœªçŸ¥é”™è¯¯')}"
                    self.status_label.text = "æŸ¥è¯¢å¤±è´¥"
            else:
                self.result_text.value = f"HTTPé”™è¯¯: {response.status_code}\nå“åº”å†…å®¹: {response.text}"
                self.status_label.text = "ç½‘ç»œé”™è¯¯"

        except Exception as e:
            self.result_text.value = f"æŸ¥è¯¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}"
            self.status_label.text = "é”™è¯¯"

    def query_sol_data(self, data):
        """æŸ¥è¯¢çƒ½ç«åœ°å¸¦æ•°æ®"""
        sol_detail = data.get('solDetail', {})
        return self.format_sol_result(sol_detail)

    def query_mp_data(self, data):
        """æŸ¥è¯¢å…¨é¢æˆ˜åœºæ•°æ®"""
        mp_detail = data.get('mpDetail', {})
        return self.format_mp_result(mp_detail)

    def query_weekly_data(self, data):
        """æŸ¥è¯¢æˆ˜åœºå‘¨æŠ¥æ•°æ®"""
        return self.format_weekly_result(data)

    def query_sol_weekly_data(self, data):
        """æŸ¥è¯¢çƒ½ç«å‘¨æŠ¥æ•°æ®"""
        return self.format_sol_weekly_result(data)

    def query_daily_secret(self, data):
        """æŸ¥è¯¢æ¯æ—¥å¯†ç æ•°æ®"""
        return self.format_daily_secret_result(data)

    def query_special_force_status(self, data):
        """æŸ¥è¯¢ç‰¹å‹¤å¤„çŠ¶æ€æ•°æ®"""
        return self.format_special_force_result(data)

    def format_sol_result(self, sol_detail):
        """æ ¼å¼åŒ–çƒ½ç«åœ°å¸¦æŸ¥è¯¢ç»“æœ"""
        result = []

        # åŸºæœ¬ä¿¡æ¯
        recent_gain = sol_detail.get('recentGain', 0)
        recent_gain_date = sol_detail.get('recentGainDate', '')
        current_time = sol_detail.get('currentTime', '')

        result.append(f"=== çƒ½ç«åœ°å¸¦æ˜¨æ—¥æ”¶ç›ŠæŠ¥å‘Š ===")
        result.append(f"æŸ¥è¯¢æ—¶é—´: {current_time}")
        result.append(f"æ”¶ç›Šæ—¥æœŸ: {recent_gain_date}")
        result.append(f"æ˜¨æ—¥æ€»æ”¶ç›Š: {recent_gain:,} é‡‘å¸")
        result.append("")

        # Top3ç‰©å“ä¿¡æ¯
        user_collection_top = sol_detail.get('userCollectionTop', {})
        top_date = user_collection_top.get('date', '')
        items_list = user_collection_top.get('list', [])

        result.append(f"æ”¶ç›ŠTop3ç‰©å“ (ç»Ÿè®¡æ—¥æœŸ: {top_date}):")
        result.append("-" * 50)

        if items_list:
            for i, item in enumerate(items_list, 1):
                object_id = item.get('objectID', 'æœªçŸ¥')
                count = item.get('count', '0')
                price = float(item.get('price', '0'))

                result.append(f"{i}. ç‰©å“ID: {object_id}")
                result.append(f"   å¸¦å‡ºæ•°é‡: {count}")
                result.append(f"   ç‰©å“ä»·å€¼: {price:,.2f} é‡‘å¸")
                result.append("")
        else:
            result.append("æš‚æ— æ”¶ç›Šç‰©å“æ•°æ®")

        return "\n".join(result)

    def format_mp_result(self, mp_detail):
        """æ ¼å¼åŒ–å…¨é¢æˆ˜åœºæŸ¥è¯¢ç»“æœ"""
        result = []

        # åŸºæœ¬ä¿¡æ¯
        total_kill_num = mp_detail.get('totalKillNum', 0)
        total_win_num = mp_detail.get('totalWinNum', 0)
        total_fight_num = mp_detail.get('totalFightNum', 0)
        total_score = mp_detail.get('totalScore', 0)
        most_use_force_type = mp_detail.get('mostUseForceType', 0)
        recent_date = mp_detail.get('recentDate', '')
        current_time = mp_detail.get('currentTime', '')
        best_match = mp_detail.get('bestMatch', {})

        # è®¡ç®—èƒœç‡
        win_rate = (total_win_num / total_fight_num * 100) if total_fight_num > 0 else 0

        # è®¡ç®—å¹³å‡å‡»æ€å’Œå¹³å‡å¾—åˆ†
        avg_kills = total_kill_num / total_fight_num if total_fight_num > 0 else 0
        avg_score = total_score / total_fight_num if total_fight_num > 0 else 0

        result.append(f"=== å…¨é¢æˆ˜åœºæ˜¨æ—¥æˆ˜æŠ¥ ===")
        result.append(f"æŸ¥è¯¢æ—¶é—´: {current_time}")
        result.append(f"ç»Ÿè®¡æ—¥æœŸ: {recent_date}")
        result.append("")
        result.append("=== æ€»ä½“æ•°æ® ===")
        result.append(f"æ€»å‡»æ€æ•°: {total_kill_num:,}")
        result.append(f"æ€»å®Œæˆå¯¹å±€æ•°: {total_fight_num:,}")
        result.append(f"è·èƒœå¯¹å±€æ•°: {total_win_num:,}")
        result.append(f"èƒœç‡: {win_rate:.1f}%")
        result.append(f"æ€»å¾—åˆ†: {total_score:,}")
        result.append(f"å¹³å‡å‡»æ€: {avg_kills:.1f}")
        result.append(f"å¹³å‡å¾—åˆ†: {avg_score:.1f}")
        result.append(f"å¸¸ç”¨å¹²å‘˜ID: {most_use_force_type}")
        result.append("")

        # é«˜å…‰å¯¹å±€ä¿¡æ¯
        if best_match:
            assist = best_match.get('assist', 0)
            death = best_match.get('death', 0)
            is_winner = best_match.get('isWinner', 0)
            game_time = best_match.get('gameTime', 0)
            kill_num = best_match.get('killNum', 0)
            map_id = best_match.get('mapID', 0)
            score = best_match.get('score', 0)
            start_time = best_match.get('startTime', '')
            dt_event_time = best_match.get('dtEventTime', '')

            # è½¬æ¢æ—¶é—´æˆ³ä¸ºå¯è¯»æ ¼å¼
            try:
                if start_time and start_time.isdigit():
                    start_time_dt = datetime.fromtimestamp(int(start_time))
                    start_time_str = start_time_dt.strftime('%Y-%m-%d %H:%M:%S')
                else:
                    start_time_str = start_time
            except:
                start_time_str = start_time

            result.append("=== é«˜å…‰å¯¹å±€ ===")
            result.append(f"å¯¹å±€æ—¶é—´: {dt_event_time}")
            result.append(f"å¼€å§‹æ—¶é—´: {start_time_str}")
            result.append(f"åœ°å›¾ID: {map_id}")
            result.append(f"å¯¹å±€ç»“æœ: {'èƒœåˆ©' if is_winner == 1 else 'å¤±è´¥'}")
            result.append(f"å¯¹å±€æ—¶é•¿: {game_time} ç§’ ({game_time // 60}åˆ†{game_time % 60}ç§’)")
            result.append(f"å‡»æ€æ•°: {kill_num:,}")
            result.append(f"æ´åŠ©æ•°: {assist:,}")
            result.append(f"æ­»äº¡æ•°: {death:,}")
            result.append(f"å¾—åˆ†: {score:,}")

            # è®¡ç®—KDA
            kda = (kill_num + assist) / death if death > 0 else kill_num + assist
            result.append(f"KDA: {kda:.2f}")

            # è®¡ç®—æ¯åˆ†é’Ÿæ•°æ®
            minutes = game_time / 60 if game_time > 0 else 1
            kills_per_min = kill_num / minutes
            score_per_min = score / minutes
            result.append(f"æ¯åˆ†é’Ÿå‡»æ€: {kills_per_min:.2f}")
            result.append(f"æ¯åˆ†é’Ÿå¾—åˆ†: {score_per_min:.2f}")
        else:
            result.append("æš‚æ— é«˜å…‰å¯¹å±€æ•°æ®")

        return "\n".join(result)

    def format_weekly_result(self, data):
        """æ ¼å¼åŒ–æˆ˜åœºå‘¨æŠ¥æŸ¥è¯¢ç»“æœ"""
        result = []

        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if not data:
            return "æœ¬å‘¨æš‚æ— æˆ˜åœºå‘¨æŠ¥æ•°æ®"

        # è·å–å½“å‰æ—¥æœŸï¼Œè®¡ç®—ç»Ÿè®¡å‘¨æœŸ
        today = datetime.now()
        days_since_sunday = today.weekday() + 1  # 0=å‘¨ä¸€, 6=å‘¨æ—¥
        last_sunday = today - timedelta(days=days_since_sunday % 7)
        week_start = last_sunday - timedelta(days=6)  # å‘¨ä¸€å¼€å§‹

        result.append(f"=== æˆ˜åœºå‘¨æŠ¥æ•°æ® (ç»Ÿè®¡å‘¨æœŸ: {week_start.strftime('%Y-%m-%d')} è‡³ {last_sunday.strftime('%Y-%m-%d')}) ===")
        result.append("")

        # åŸºç¡€ç»Ÿè®¡æ•°æ®
        total_num = int(data.get('total_num', 0))
        win_num = int(data.get('win_num', 0))
        total_gametime = int(data.get('total_gametime', 0))
        kill_num = int(data.get('Kill_Num', 0))
        total_score = int(data.get('total_score', 0))
        rank_match_score = int(data.get('Rank_Match_Score', 0))

        # è®¡ç®—èƒœç‡å’Œå¹³å‡æ•°æ®
        win_rate = (win_num / total_num * 100) if total_num > 0 else 0
        avg_kills = kill_num / total_num if total_num > 0 else 0
        avg_score = total_score / total_num if total_num > 0 else 0

        # æ¸¸æˆæ—¶é•¿è½¬æ¢
        hours = total_gametime // 3600
        minutes = (total_gametime % 3600) // 60

        result.append("=== åŸºç¡€ç»Ÿè®¡ ===")
        result.append(f"å¯¹å±€åœºæ¬¡: {total_num:,}")
        result.append(f"èƒœåœº: {win_num:,}")
        result.append(f"èƒœç‡: {win_rate:.1f}%")
        result.append(f"æ€»æ¸¸æˆæ—¶é•¿: {total_gametime:,}ç§’ ({hours}å°æ—¶{minutes}åˆ†é’Ÿ)")
        result.append(f"æ€»å‡»æ€æ•°: {kill_num:,}")
        result.append(f"å¹³å‡å‡»æ€: {avg_kills:.1f}")
        result.append(f"æ€»å¾—åˆ†: {total_score:,}")
        result.append(f"å¹³å‡å¾—åˆ†: {avg_score:.1f}")
        result.append(f"æ’ä½åˆ†æ•°: {rank_match_score:,}")
        result.append("")

        # æˆ˜æ–—æ•°æ®
        consume_bullet_num = int(data.get('Consume_Bullet_Num', 0))
        hit_bullet_num = int(data.get('Hit_Bullet_Num', 0))
        kill_type1_num = int(data.get('Kill_type1_Num', 0))
        continuous_kill_num = float(data.get('continuous_Kill_Num', 0))

        # è®¡ç®—å‘½ä¸­ç‡
        hit_rate = (hit_bullet_num / consume_bullet_num * 100) if consume_bullet_num > 0 else 0

        result.append("=== æˆ˜æ–—æ•°æ® ===")
        result.append(f"æ¶ˆè€—å¼¹è¯æ•°: {consume_bullet_num:,}")
        result.append(f"å‘½ä¸­å­å¼¹æ•°: {hit_bullet_num:,}")
        result.append(f"å‘½ä¸­ç‡: {hit_rate:.1f}%")
        result.append(f"è½½å…·å‡»æ€æ•°: {kill_type1_num:,}")
        result.append(f"æœ€é«˜è¿ç»­å‡»æ€: {continuous_kill_num:.1f}")
        result.append("")

        # å›¢é˜Ÿæ•°æ®
        rescue_teammate_count = int(data.get('Rescue_Teammate_Count', 0))
        rescue_campmate_count = int(data.get('Rescue_Campmate_Count', 0))
        by_rescue_num = int(data.get('by_Rescue_num', 0))
        teammate_reborn_num = int(data.get('Teammate_Reborn_Num', 0))
        total_occupy = int(data.get('total_Occupy', 0))

        result.append("=== å›¢é˜Ÿæ•°æ® ===")
        result.append(f"æ•‘æ´å°é˜Ÿé˜Ÿå‹æ•°: {rescue_teammate_count:,}")
        result.append(f"æ•‘æ´é˜µè¥é˜Ÿå‹æ•°: {rescue_campmate_count:,}")
        result.append(f"è¢«æ•‘æ´æ¬¡æ•°: {by_rescue_num:,}")
        result.append(f"é˜Ÿå‹é‡ç”Ÿæ¬¡æ•°: {teammate_reborn_num:,}")
        result.append(f"å ç‚¹æ•°: {total_occupy:,}")
        result.append("")

        # æ”¯æ´æ•°æ®
        sbattle_support_usenum = float(data.get('SBattle_Support_UseNum', 0))
        sbattle_support_costscore = float(data.get('SBattle_Support_CostScore', 0))

        result.append("=== æ”¯æ´æ•°æ® ===")
        result.append(f"å±€å†…æ”¯æ´å‘¼å«æ¬¡æ•°: {sbattle_support_usenum:.1f}")
        result.append(f"æ”¯æ´æ¶ˆè€—åˆ†æ•°: {sbattle_support_costscore:,.0f}")
        result.append("")

        # å¹²å‘˜æ•°æ®
        deploy_armed_force_type = data.get('max_inum_DeployArmedForceType', '0')
        deploy_kill_num = int(data.get('DeployArmedForceType_KillNum', 0))
        deploy_gametime = int(data.get('DeployArmedForceType_gametime', 0))
        deploy_inum = int(data.get('DeployArmedForceType_inum', 0))

        # åœ°å›¾æ•°æ®è§£æ
        map_info = data.get('max_inum_mapid', '')
        map_data = []
        if map_info and map_info.startswith('{'):
            try:
                # è§£æåœ°å›¾æ•°æ®æ ¼å¼: {'MapId':303,'inum':1}#{'MapId':107,'inum':1}...
                map_entries = map_info.split('#')
                for entry in map_entries:
                    if entry.startswith('{') and entry.endswith('}'):
                        # ç®€å•è§£æï¼Œæå–åœ°å›¾IDå’Œåœºæ¬¡
                        parts = entry.strip('{}').split(',')
                        map_id = parts[0].split(':')[1] if len(parts) > 0 else 'æœªçŸ¥'
                        inum = parts[1].split(':')[1] if len(parts) > 1 else '0'
                        map_data.append((map_id, int(inum)))
            except:
                pass

        result.append("=== å¹²å‘˜æ•°æ® ===")
        result.append(f"æœ¬å‘½å¹²å‘˜ID: {deploy_armed_force_type}")
        result.append(f"æœ¬å‘½å¹²å‘˜å‡»æ€æ•°: {deploy_kill_num:,}")
        result.append(f"æœ¬å‘½å¹²å‘˜æ¸¸æˆæ—¶é•¿: {deploy_gametime:,}ç§’")
        result.append(f"æœ¬å‘½å¹²å‘˜å®Œæˆå¯¹å±€: {deploy_inum:,}")
        result.append("")

        if map_data:
            result.append("=== åœ°å›¾åˆ†å¸ƒ ===")
            for map_id, inum in sorted(map_data, key=lambda x: x[1], reverse=True)[:5]:  # æ˜¾ç¤ºå‰5ä¸ªåœ°å›¾
                result.append(f"åœ°å›¾ID {map_id}: {inum}åœº")

        return "\n".join(result)

    def format_sol_weekly_result(self, data):
        """æ ¼å¼åŒ–çƒ½ç«å‘¨æŠ¥æŸ¥è¯¢ç»“æœ"""
        result = []

        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if not data:
            return "æœ¬å‘¨æš‚æ— çƒ½ç«å‘¨æŠ¥æ•°æ®"

        # è·å–å½“å‰æ—¥æœŸï¼Œè®¡ç®—ç»Ÿè®¡å‘¨æœŸ
        today = datetime.now()
        days_since_sunday = today.weekday() + 1  # 0=å‘¨ä¸€, 6=å‘¨æ—¥
        last_sunday = today - timedelta(days=days_since_sunday % 7)
        week_start = last_sunday - timedelta(days=6)  # å‘¨ä¸€å¼€å§‹

        result.append(f"=== çƒ½ç«å‘¨æŠ¥æ•°æ® (ç»Ÿè®¡å‘¨æœŸ: {week_start.strftime('%Y-%m-%d')} è‡³ {last_sunday.strftime('%Y-%m-%d')}) ===")
        result.append("")

        # åŸºç¡€ç»Ÿè®¡æ•°æ®
        total_sol_num = int(data.get('total_sol_num', 0))
        total_exacuation_num = int(data.get('total_exacuation_num', 0))
        total_Quest_num = int(data.get('total_Quest_num', 0))
        total_Online_Time = int(data.get('total_Online_Time', 0))

        # è®¡ç®—æ’¤ç¦»ç‡å’Œå¹³å‡åœ¨çº¿æ—¶é•¿
        evacuation_rate = (total_exacuation_num / total_sol_num * 100) if total_sol_num > 0 else 0
        avg_online_time = total_Online_Time / total_sol_num if total_sol_num > 0 else 0

        # åœ¨çº¿æ—¶é•¿è½¬æ¢
        hours = total_Online_Time // 3600
        minutes = (total_Online_Time % 3600) // 60

        result.append("=== åŸºç¡€ç»Ÿè®¡ ===")
        result.append(f"æœ¬å‘¨å¯¹å±€æ•°: {total_sol_num:,}")
        result.append(f"æ’¤ç¦»æˆåŠŸæ•°: {total_exacuation_num:,}")
        result.append(f"æ’¤ç¦»ç‡: {evacuation_rate:.1f}%")
        result.append(f"å®Œæˆä»»åŠ¡æ•°: {total_Quest_num:,}")
        result.append(f"æ€»åœ¨çº¿æ—¶é•¿: {total_Online_Time:,}ç§’ ({hours}å°æ—¶{minutes}åˆ†é’Ÿ)")
        result.append(f"å¹³å‡åœ¨çº¿æ—¶é•¿: {avg_online_time:.1f}ç§’")
        result.append("")

        # ç»æµæ•°æ®
        gained_price = int(data.get('Gained_Price', 0))
        consume_price = int(data.get('consume_Price', 0))
        rise_price = int(data.get('rise_Price', 0))
        total_price = data.get('Total_Price', '')

        # è®¡ç®—å¹³å‡æ”¶ç›Šå’Œåˆ©æ¶¦ç‡
        avg_gain = gained_price / total_sol_num if total_sol_num > 0 else 0
        profit_margin = (rise_price / consume_price * 100) if consume_price > 0 else 0

        result.append("=== ç»æµæ•°æ® ===")
        result.append(f"æœ¬å‘¨æ€»å¸¦å‡ºå“ˆå¤«å¸: {gained_price:,}")
        result.append(f"æœ¬å‘¨æ€»å¸¦å…¥å“ˆå¤«å¸: {consume_price:,}")
        result.append(f"æœ¬å‘¨æ€»åˆ©æ¶¦: {rise_price:,}")
        result.append(f"å¹³å‡æ¯å±€æ”¶ç›Š: {avg_gain:,.0f}")
        result.append(f"åˆ©æ¶¦ç‡: {profit_margin:.1f}%")
        result.append("")

        # è§£ææ¯æ—¥ä»“åº“ä»·å€¼
        if total_price:
            try:
                price_entries = total_price.split(',')
                result.append("=== æ¯æ—¥ä»“åº“ä»·å€¼ ===")
                for entry in price_entries:
                    if '-' in entry:
                        parts = entry.split('-')
                        if len(parts) >= 3:
                            day = parts[0]
                            date = parts[1]
                            value = parts[2]
                            result.append(f"{day} ({date}): {int(value):,}")
            except:
                pass
            result.append("")

        # å‡»æ€æ•°æ®
        total_kill_count = int(data.get('total_Kill_Count', 0))
        total_kill_player = int(data.get('total_Kill_Player', 0))
        total_kill_ai = int(data.get('total_Kill_AI', 0))
        total_kill_boss = int(data.get('total_Kill_Boss', 0))
        total_death_count = int(data.get('total_Death_Count', 0))
        total_rescue_num = int(data.get('total_Rescue_num', 0))

        # è®¡ç®—KDæ¯”å’Œç”Ÿå­˜ç‡
        kd_ratio = total_kill_count / total_death_count if total_death_count > 0 else total_kill_count
        survival_rate = ((total_sol_num - total_death_count) / total_sol_num * 100) if total_sol_num > 0 else 0

        result.append("=== æˆ˜æ–—æ•°æ® ===")
        result.append(f"æ€»å‡»æ€æ•°: {total_kill_count:,}")
        result.append(f"å‡»è´¥å¹²å‘˜æ•°: {total_kill_player:,}")
        result.append(f"å‡»æ€AIæ•°: {total_kill_ai:,}")
        result.append(f"å‡»æ€BOSSæ•°: {total_kill_boss:,}")
        result.append(f"æ­»äº¡æ¬¡æ•°: {total_death_count:,}")
        result.append(f"KDæ¯”: {kd_ratio:.2f}")
        result.append(f"ç”Ÿå­˜ç‡: {survival_rate:.1f}%")
        result.append(f"æ•‘æ´æ¬¡æ•°: {total_rescue_num:,}")
        result.append("")

        # ç‰¹æ®Šæ•°æ®
        gained_price_overmillion_num = int(data.get('GainedPrice_overmillion_num', 0))
        teammate_price_overzero_num = int(data.get('TeammatePrice_overzero_num', 0))
        kill_by_crocodile_num = int(data.get('Kill_ByCrocodile_num', 0))
        search_birdsnest_num = int(data.get('search_Birdsnest_num', 0))
        mandel_brick_num = int(data.get('Mandel_brick_num', 0))
        use_keycard_num = int(data.get('use_Keycard_num', 0))
        total_mileage = int(data.get('Total_Mileage', 0))
        rank_score = int(data.get('Rank_Score', 0))

        result.append("=== ç‰¹æ®Šæ•°æ® ===")
        result.append(f"ç™¾ä¸‡æ’¤ç¦»åœºæ¬¡: {gained_price_overmillion_num:,}")
        result.append(f"é˜Ÿå‹ä»·æ ¼ä¸ºæ­£æ¬¡æ•°: {teammate_price_overzero_num:,}")
        result.append(f"è¢«é³„é±¼æ€æ­»æ¬¡æ•°: {kill_by_crocodile_num:,}")
        result.append(f"æœç´¢é¸Ÿå·¢æ•°: {search_birdsnest_num:,}")
        result.append(f"æ›¼å¾·å°”ç –ç ´è¯‘æ•°: {mandel_brick_num:,}")
        result.append(f"æ¶ˆè€—é’¥åŒ™æ•°: {use_keycard_num:,}")
        result.append(f"æ€»é‡Œç¨‹: {total_mileage:,}ç±³")
        result.append(f"æ’ä½åˆ†æ•°: {rank_score:,}")
        result.append("")

        # å¹²å‘˜ä½¿ç”¨æ•°æ®è§£æ
        armed_force_info = data.get('total_ArmedForceId_num', '')
        armed_force_data = []
        if armed_force_info and armed_force_info.startswith('{'):
            try:
                # è§£æå¹²å‘˜æ•°æ®æ ¼å¼: {'ArmedForceId':40005,'inum':2}#{'ArmedForceId':20004,'inum':10}...
                entries = armed_force_info.split('#')
                for entry in entries:
                    if entry.startswith('{') and entry.endswith('}'):
                        parts = entry.strip('{}').split(',')
                        force_id = parts[0].split(':')[1] if len(parts) > 0 else 'æœªçŸ¥'
                        inum = parts[1].split(':')[1] if len(parts) > 1 else '0'
                        armed_force_data.append((force_id, int(inum)))
            except:
                pass

        # å¹²å‘˜IDæ˜ å°„
        force_map = {
            '10007': 'çº¢ç‹¼', '10010': 'å¨é¾™', '10011': 'æ— å',
            '20003': 'èœ‚åŒ»', '20004': 'è›Š', '30008': 'ç‰§ç¾Šäºº',
            '30011': 'æ¯”ç‰¹', '40005': 'éœ²å¨œ', '40010': 'éª‡çˆª', '10012': 'ç–¾é£'
        }

        if armed_force_data:
            result.append("=== å¹²å‘˜ä½¿ç”¨æƒ…å†µ ===")
            for force_id, inum in sorted(armed_force_data, key=lambda x: x[1], reverse=True):
                force_name = force_map.get(force_id, f'å¹²å‘˜{force_id}')
                result.append(f"{force_name} (ID:{force_id}): {inum}åœº")
            result.append("")

        # åœ°å›¾æ•°æ®è§£æ
        map_info = data.get('total_mapid_num', '')
        map_data = []
        if map_info and map_info.startswith('{'):
            try:
                # è§£æåœ°å›¾æ•°æ®æ ¼å¼: {'MapId':2202,'inum':6}#{'MapId':1901,'inum':5}...
                map_entries = map_info.split('#')
                for entry in map_entries:
                    if entry.startswith('{') and entry.endswith('}'):
                        parts = entry.strip('{}').split(',')
                        map_id = parts[0].split(':')[1] if len(parts) > 0 else 'æœªçŸ¥'
                        inum = parts[1].split(':')[1] if len(parts) > 1 else '0'
                        map_data.append((map_id, int(inum)))
            except:
                pass

        if map_data:
            result.append("=== åœ°å›¾åˆ†å¸ƒ ===")
            for map_id, inum in sorted(map_data, key=lambda x: x[1], reverse=True)[:5]:  # æ˜¾ç¤ºå‰5ä¸ªåœ°å›¾
                result.append(f"åœ°å›¾ID {map_id}: {inum}åœº")
            result.append("")

        # é«˜ä»·å€¼ç‰©å“åˆ—è¡¨
        carry_out_highprice_list = data.get('CarryOut_highprice_list', '')
        if carry_out_highprice_list and len(carry_out_highprice_list) > 10:
            try:
                # è§£æé«˜ä»·å€¼ç‰©å“æ ¼å¼: {'itemid':13120000256,'inum':1,'auctontype':é…ä»¶,'quality':5.0,'iPrice':25534.0}...
                items = carry_out_highprice_list.split('#')
                if items:
                    result.append("=== æœ¬å‘¨å¸¦å‡ºé«˜ä»·å€¼ç‰©å“ (å‰10ä¸ª) ===")
                    for i, item in enumerate(items[:10], 1):
                        if item.startswith('{') and item.endswith('}'):
                            # ç®€å•è§£ææ˜¾ç¤ºç‰©å“IDå’Œä»·å€¼
                            parts = item.strip('{}').split(',')
                            item_id = ''
                            price = ''
                            for part in parts:
                                if 'itemid:' in part:
                                    item_id = part.split(':')[1]
                                elif 'iPrice:' in part:
                                    price = part.split(':')[1]
                            if item_id and price:
                                result.append(f"{i}. ç‰©å“ID: {item_id}, ä»·å€¼: {float(price):,.0f}")
                    result.append("")
            except:
                pass

        return "\n".join(result)

    def format_daily_secret_result(self, data):
        """æ ¼å¼åŒ–æ¯æ—¥å¯†ç æŸ¥è¯¢ç»“æœ"""
        result = []

        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if not data:
            return "æš‚æ— æ¯æ—¥å¯†ç æ•°æ®"

        # å½“å‰æ—¶é—´
        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        result.append(f"=== æ¯æ—¥å¯†ç æŸ¥è¯¢æŠ¥å‘Š ===")
        result.append(f"æŸ¥è¯¢æ—¶é—´: {current_time}")
        result.append("")

        # è·å–å¯†ç åˆ—è¡¨
        secret_list = data.get('list', [])

        if secret_list:
            result.append("=== ä»Šæ—¥åœ°å›¾å¯†ç  ===")
            result.append("-" * 40)

            # åœ°å›¾IDåˆ°åç§°çš„æ˜ å°„
            map_names = {
                1: "é›¶å·å¤§å",
                2: "é•¿å¼“æºªè°·",
                3: "å·´å…‹ä»€",
                4: "èˆªå¤©åŸºåœ°",
                5: "æ½®æ±ç›‘ç‹±"
            }

            for secret_info in secret_list:
                map_id = secret_info.get('mapID', 0)
                map_name = map_names.get(map_id, f"æœªçŸ¥åœ°å›¾({map_id})")
                secret = secret_info.get('secret', 'æœªçŸ¥')

                result.append(f"ã€{map_name}ã€‘")
                result.append(f"åœ°å›¾ID: {map_id}")
                result.append(f"ä»Šæ—¥å¯†ç : {secret}")
                result.append("")

            # æ·»åŠ ä½¿ç”¨è¯´æ˜
            result.append("=== ä½¿ç”¨è¯´æ˜ ===")
            result.append("-" * 40)
            result.append("â€¢ å¯†ç å¯ç”¨äºè¿›å…¥å¯¹åº”åœ°å›¾çš„ç‰¹æ®ŠåŒºåŸŸ")
            result.append("â€¢ æ¯æ—¥å¯†ç ä¼šåœ¨æœåŠ¡å™¨æ—¶é—´00:00åˆ·æ–°")
            result.append("â€¢ ä¸åŒåœ°å›¾çš„å¯†ç å¯èƒ½ä¸åŒ")
            result.append("â€¢ è¯·å¦¥å–„ä¿ç®¡å¯†ç ï¼Œé¿å…æ³„éœ²")
            result.append("")

            # æ·»åŠ æç¤ºä¿¡æ¯
            result.append("ğŸ’¡ æç¤º: ç‚¹å‡»å¯†ç åŒºåŸŸå¯ä»¥å¤åˆ¶å¯†ç å†…å®¹")
        else:
            result.append("ä»Šæ—¥æš‚æ— åœ°å›¾å¯†ç ä¿¡æ¯")
            result.append("")
            result.append("å¯èƒ½åŸå› :")
            result.append("- æœåŠ¡å™¨ç»´æŠ¤ä¸­")
            result.append("- å¯†ç å°šæœªåˆ·æ–°")
            result.append("- ç½‘ç»œè¿æ¥é—®é¢˜")

        return "\n".join(result)

    def format_special_force_result(self, data):
        """æ ¼å¼åŒ–ç‰¹å‹¤å¤„çŠ¶æ€æŸ¥è¯¢ç»“æœ"""
        result = []

        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if not data:
            return "æš‚æ— ç‰¹å‹¤å¤„çŠ¶æ€æ•°æ®"

        # å½“å‰æ—¶é—´
        now_time = data.get('nowTime', 0)
        current_time_str = datetime.fromtimestamp(now_time).strftime('%Y-%m-%d %H:%M:%S') if now_time > 0 else "æœªçŸ¥"

        result.append(f"=== ç‰¹å‹¤å¤„çŠ¶æ€æŠ¥å‘Š ===")
        result.append(f"æŸ¥è¯¢æ—¶é—´: {current_time_str}")
        result.append("")

        # ç‰¹å‹¤å¤„è®¾æ–½æ•°æ®
        place_data = data.get('placeData', [])

        if place_data:
            result.append("=== è®¾æ–½çŠ¶æ€ ===")

            # æŒ‰è®¾æ–½ç±»å‹åˆ†ç±»æ˜¾ç¤º
            facilities_by_type = {}
            for facility in place_data:
                place_type = facility.get('placeType', 'æœªçŸ¥')
                if place_type not in facilities_by_type:
                    facilities_by_type[place_type] = []
                facilities_by_type[place_type].append(facility)

            # æ˜¾ç¤ºæ¯ä¸ªè®¾æ–½çš„çŠ¶æ€
            for facility in place_data:
                facility_id = facility.get('Id', 'æœªçŸ¥')
                facility_name = facility.get('placeName', 'æœªçŸ¥è®¾æ–½')
                status = facility.get('Status', 'æœªçŸ¥')
                level = facility.get('Level', '0')

                result.append(f"ã€{facility_name} (ID:{facility_id})ã€‘")
                result.append(f"ç­‰çº§: {level}çº§")
                result.append(f"çŠ¶æ€: {status}")

                # å¦‚æœè®¾æ–½æ­£åœ¨ç”Ÿäº§ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                left_time = facility.get('leftTime', 0)
                push_time = facility.get('pushTime', 0)
                object_id = facility.get('objectId', 0)

                if left_time > 0 and push_time > 0:
                    # è®¡ç®—å‰©ä½™æ—¶é—´
                    hours = left_time // 3600
                    minutes = (left_time % 3600) // 60
                    seconds = left_time % 60

                    # ç”Ÿäº§å¼€å§‹æ—¶é—´
                    start_time_str = datetime.fromtimestamp(push_time).strftime('%Y-%m-%d %H:%M:%S')

                    result.append(f"ç”Ÿäº§ç‰©å“ID: {object_id}")
                    result.append(f"å¼€å§‹ç”Ÿäº§æ—¶é—´: {start_time_str}")
                    result.append(f"å‰©ä½™æ—¶é—´: {hours}å°æ—¶{minutes}åˆ†é’Ÿ{seconds}ç§’")

                result.append("")
        else:
            result.append("æš‚æ— è®¾æ–½æ•°æ®")
            result.append("")

        # ç‰©å“æ˜ å°„è¡¨ä¿¡æ¯
        relate_map = data.get('relateMap', {})
        if relate_map:
            # æŸ¥æ‰¾æ­£åœ¨ç”Ÿäº§çš„ç‰©å“ä¿¡æ¯
            producing_items = []
            for facility in place_data:
                object_id = facility.get('objectId', 0)
                if object_id > 0 and str(object_id) in relate_map:
                    producing_items.append((facility, relate_map[str(object_id)]))

            if producing_items:
                result.append("=== æ­£åœ¨ç”Ÿäº§çš„ç‰©å“ ===")
                for facility, item_info in producing_items:
                    object_name = item_info.get('objectName', 'æœªçŸ¥ç‰©å“')
                    grade = item_info.get('grade', 0)
                    avg_price = item_info.get('avgPrice', 0)

                    result.append(f"ç‰©å“åç§°: {object_name}")
                    result.append(f"ç‰©å“ç­‰çº§: {grade}çº§")
                    result.append(f"å¹³å‡ä»·æ ¼: {avg_price:,} é‡‘å¸")

                    # æ˜¾ç¤ºç‰©å“è¯¦ç»†ä¿¡æ¯
                    if item_info.get('primaryClass') == 'acc':
                        acc_detail = item_info.get('accDetail', {})
                        if acc_detail:
                            control_speed = acc_detail.get('controlSpeed', 0)
                            result.append(f"æ“æ§é€Ÿåº¦: {control_speed}")
                    elif item_info.get('primaryClass') == 'props':
                        props_detail = item_info.get('propsDetail', {})
                        if props_detail:
                            active_time = props_detail.get('activeTime', 'æœªçŸ¥')
                            result.append(f"æŒç»­æ—¶é—´: {active_time}ç§’")

                    result.append("")

        # å°ç¨‹åºè®°å½•
        applet_record = data.get('appletRecord', [])
        if applet_record:
            result.append("=== å°ç¨‹åºè®°å½• ===")
            for record in applet_record:
                result.append(f"- {record}")
            result.append("")

        return "\n".join(result)

    def query_all_currencies(self, url, params, headers):
        """åŒæ—¶æŸ¥è¯¢ä¸‰ç§è´§å¸ç±»å‹"""
        result = []

        # å½“å‰æ—¶é—´
        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        result.append(f"=== è´§å¸èµ„äº§æŸ¥è¯¢æŠ¥å‘Š ===")
        result.append(f"æŸ¥è¯¢æ—¶é—´: {current_time}")
        result.append("")

        # ä¸‰ç§è´§å¸ç±»å‹çš„ID
        currency_items = [
            ('17020000010', 'å“ˆå¤«å¸'),
            ('17888808889', 'ä¸‰è§’åˆ¸'),
            ('17888808888', 'ä¸‰è§’å¸')
        ]

        total_assets = 0

        for item_id, currency_name in currency_items:
            try:
                # ä¿®æ”¹å‚æ•°ä¸­çš„item
                query_params = params.copy()
                query_params['item'] = item_id

                # å‘é€POSTè¯·æ±‚
                response = requests.post(url, params=query_params, headers=headers, timeout=10)

                if response.status_code == 200:
                    data = response.json()

                    if data.get('ret') == 0 and data.get('iRet') == 0:
                        jdata = data.get('jData', {})
                        data_content = jdata.get('data', [])

                        if isinstance(data_content, list) and len(data_content) > 0:
                            currency_data = data_content[0]
                            total_money = currency_data.get('totalMoney', '0')
                            money_amount = int(total_money)
                            total_assets += money_amount

                            result.append(f"=== {currency_name} ===")
                            result.append(f"æ•°é‡: {money_amount:,}")

                            # æ·»åŠ èµ„äº§çŠ¶æ€è¯„ä¼°
                            if money_amount > 1000000:
                                result.append("ğŸ’° èµ„äº§çŠ¶æ€: å¯Œæœ‰")
                            elif money_amount > 500000:
                                result.append("ğŸ’µ èµ„äº§çŠ¶æ€: å°åº·")
                            elif money_amount > 100000:
                                result.append("ğŸ’¸ èµ„äº§çŠ¶æ€: ä¸€èˆ¬")
                            else:
                                result.append("ğŸ’³ èµ„äº§çŠ¶æ€: éœ€è¦ç§¯ç´¯")
                            result.append("")
                        else:
                            result.append(f"{currency_name}: æ•°æ®æ ¼å¼å¼‚å¸¸")
                            result.append("")
                    else:
                        result.append(f"{currency_name}: æŸ¥è¯¢å¤±è´¥ - {data.get('sMsg', 'æœªçŸ¥é”™è¯¯')}")
                        result.append("")
                else:
                    result.append(f"{currency_name}: HTTPé”™è¯¯ - {response.status_code}")
                    result.append("")
            except Exception as e:
                result.append(f"{currency_name}: æŸ¥è¯¢é”™è¯¯ - {str(e)}")
                result.append("")

        # æ˜¾ç¤ºæ€»èµ„äº§
        result.append("=== æ€»èµ„äº§ç»Ÿè®¡ ===")
        result.append(f"ä¸‰ç§è´§å¸æ€»ä»·å€¼: {total_assets:,} å“ˆå¤«å¸")
        result.append("")

        # æ·»åŠ èµ„äº§çŠ¶æ€è¯„ä¼°
        if total_assets > 30000000:
            result.append("ğŸ’° æ€»ä½“èµ„äº§çŠ¶æ€: éå¸¸å¯Œæœ‰")
        elif total_assets > 150:
            result.append("ğŸ’µ æ€»ä½“èµ„äº§çŠ¶æ€: å¯Œæœ‰")
        elif total_assets > 50:
            result.append("ğŸ’¸ æ€»ä½“èµ„äº§çŠ¶æ€: å°åº·")
        else:
            result.append("ğŸ’³ æ€»ä½“èµ„äº§çŠ¶æ€: éœ€è¦ç§¯ç´¯")

        return "\n".join(result)

    def query_currency_assets(self, data):
        """æŸ¥è¯¢è´§å¸èµ„äº§æ•°æ®"""
        return self.format_currency_assets_result(data)

    def format_currency_assets_result(self, data):
        """æ ¼å¼åŒ–è´§å¸èµ„äº§æŸ¥è¯¢ç»“æœ"""
        result = []

        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if not data:
            return "æš‚æ— è´§å¸èµ„äº§æ•°æ®"

        # å½“å‰æ—¶é—´
        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        result.append(f"=== è´§å¸èµ„äº§æŸ¥è¯¢æŠ¥å‘Š ===")
        result.append(f"æŸ¥è¯¢æ—¶é—´: {current_time}")
        result.append("")

        # è´§å¸èµ„äº§æ•°æ® - ç›´æ¥å¤„ç†æ•°æ®å¯¹è±¡
        if isinstance(data, dict):
            # å¦‚æœæ˜¯å­—å…¸ç±»å‹ï¼Œç›´æ¥è·å–totalMoneyå­—æ®µ
            total_money = data.get('totalMoney', '0')

            result.append("=== å“ˆå¤«å¸èµ„äº§ ===")
            result.append(f"å“ˆå¤«å¸æ•°é‡: {int(total_money):,}")
            result.append("")

            # æ ¹æ®APIæ–‡æ¡£ï¼Œitemå‚æ•°ä¸º17020000010ä»£è¡¨å“ˆå¤«å¸
            # å¯ä»¥æ‰©å±•æ”¯æŒå…¶ä»–è´§å¸ç±»å‹
            result.append("è´§å¸ç±»å‹è¯´æ˜:")
            result.append("- å“ˆå¤«å¸: 17020000010")
            result.append("- ä¸‰è§’åˆ¸: 17888808889")
            result.append("- ä¸‰è§’å¸: 17888808888")
            result.append("")

            # æ·»åŠ èµ„äº§çŠ¶æ€è¯„ä¼°
            money_amount = int(total_money)
            if money_amount > 1000000:
                result.append("ğŸ’° èµ„äº§çŠ¶æ€: å¯Œæœ‰")
            elif money_amount > 500000:
                result.append("ğŸ’µ èµ„äº§çŠ¶æ€: å°åº·")
            elif money_amount > 100000:
                result.append("ğŸ’¸ èµ„äº§çŠ¶æ€: ä¸€èˆ¬")
            else:
                result.append("ğŸ’³ èµ„äº§çŠ¶æ€: éœ€è¦ç§¯ç´¯")
        elif isinstance(data, list) and len(data) > 0:
            # å¦‚æœæ˜¯åˆ—è¡¨ç±»å‹ï¼Œéå†å¤„ç†æ¯ä¸ªå…ƒç´ 
            for currency_data in data:
                if isinstance(currency_data, dict):
                    total_money = currency_data.get('totalMoney', '0')

                    result.append("=== å“ˆå¤«å¸èµ„äº§ ===")
                    result.append(f"å“ˆå¤«å¸æ•°é‡: {int(total_money):,}")
                    result.append("")

                    # æ·»åŠ èµ„äº§çŠ¶æ€è¯„ä¼°
                    money_amount = int(total_money)
                    if money_amount > 1000000:
                        result.append("ğŸ’° èµ„äº§çŠ¶æ€: å¯Œæœ‰")
                    elif money_amount > 500000:
                        result.append("ğŸ’µ èµ„äº§çŠ¶æ€: å°åº·")
                    elif money_amount > 100000:
                        result.append("ğŸ’¸ èµ„äº§çŠ¶æ€: ä¸€èˆ¬")
                    else:
                        result.append("ğŸ’³ èµ„äº§çŠ¶æ€: éœ€è¦ç§¯ç´¯")
                    result.append("")
        else:
            result.append("æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œæ— æ³•è§£æè´§å¸èµ„äº§ä¿¡æ¯")

        result.append("æ”¯æŒçš„è´§å¸ç±»å‹:")
        result.append("- å“ˆå¤«å¸: 17020000010")
        result.append("- ä¸‰è§’åˆ¸: 17888808889")
        result.append("- ä¸‰è§’å¸: 17888808888")
        result.append("")
        result.append("æ³¨: å½“å‰æŸ¥è¯¢ä¸ºå“ˆå¤«å¸èµ„äº§ï¼Œå¦‚éœ€æŸ¥è¯¢å…¶ä»–è´§å¸è¯·ä¿®æ”¹itemå‚æ•°")

        return "\n".join(result)


def main():
    return DFMQueryApp("çƒ½ç«åœ°å¸¦æŸ¥è¯¢å·¥å…·", "com.dfm.query")


if __name__ == "__main__":
    app = main()
    app.main_loop()